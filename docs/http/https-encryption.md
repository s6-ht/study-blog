# https加密方式

#### 为什么需要加密？
因为http传输数据是明文的，数据在传输的过程中会经过中间代理服务器、路由器等多个物理节点，如果数据被劫持，由于数据是明文，劫持者就可以查看或篡改信息，为了防范这样的攻击，就引入了新的加密方案HTTPS。

HTTPS并不是一个新的协议，而是HTTP的加强版。其原理是在HTTP和TCP中间加了一个安全层，该安全层的核心就是对数据进行加解密。对数据进行加密的方式包括对称加密、非对称加密和混合加密。

#### 加解密过程
接着我们来谈谈浏览器和服务器进行协商加解密的过程。

首先，浏览器会给服务器发送一个随机数client_random 和一个加密的方法列表。

服务器接收后给浏览器返回另一个随机数server_random和加密方法。

现在，两者拥有三样相同的凭证: client_random、server_random和加密方法。

接着用这个加密方法将两个随机数混合起来生成密钥，这个密钥就是浏览器和服务端通信的暗号。

#### 1. 对称加密
该方式就是客户端和服务器共用一个相同的密钥，使用其就数据进行加密或解密。但是这种方式的问题在于怎么只让双方知道该密钥，而不被其他人知道。设想有以下两种解决办法：
- 由服务器生成，传给客户端。缺点在于被传输的密钥可能被劫持。
- 所有的浏览器和客户端预存一个密钥（不现实）

以上看来，对称加密也不够安全，于是出现了非对称加密。
#### 2. 非对称加密
非对称加密就是存在两个密钥，一个公钥，一个私钥。用公钥加密的内容必须用私钥才能解开；用私钥加密的内容只有用公钥才能解开。

服务器将公钥以明文的方式传给客户端，客户端将数据使用公钥进行加密传送给服务器，服务器用私钥进行解密。这条数据的安全就可以保障了（因为只有服务器有私钥）。但是当服务器使用私钥将数据进行加密后，传给客户端（由于公钥是服务器以明文的方式传递给客户端的，因此可能被劫持），这样响应的数据就不安全了。

**解决思路:** 一组公钥私钥可以保证一条线路的安全，那么用两组私钥公钥，是否可以保证两条线路的安全。

**解决过程：**
- 客户端存在私钥B和公钥B，服务器存在私钥A和公钥A
- 客户端将公钥B以明文的方式传给服务器，服务器将公钥A以明文的方式传递给客户端；
- 之后浏览器的传输内容用公钥A进行加密，服务器接收到用私钥A进行解密
- 服务器响应数据用公钥B进行加密，客户端用私钥B进行解密

**缺陷:** https的加密没有使用这种方式的原因是因为它非常耗时，而对称加密快很多。<br>
**扩展:** 那我们能不能使用非对称加密的特性来解决对称加密存在的问题呢？

#### 3. 混合加密
混合加密就是使用非对称加密的特性解决对称加密的问题，流程如下：
- 服务器拥有公钥A和私钥A
- 服务器以明文的方式将公钥A传递给浏览器
- 浏览器随机生成一个用于对称加密的密钥（共享密钥），再使用公钥A加密后传送给服务器（因为公钥只能被对应的私钥解开，所以即使被劫持了也没用）
- 服务器使用私钥A对数据进行节目得到共享密钥
- 这样，双方都拥有来共享密钥

但是在者过程中可能存在中间人攻击，这是流程就变成了这样：
- 服务器拥有公钥A和私钥A
- 服务器以明文的方式将公钥A传递给浏览器
- 中间人劫持到公钥A，保存下来，把数据包中的公钥A替换为自己伪造的公钥B（它也拥有自己的私钥B）
- 浏览器随机生成一个用于对称加密的共享密钥（浏览器无法得知公钥A被替换了），再使用公钥A加密后传送给服务器（因为公钥只能被对应的私钥解开，所以即使被劫持了也没用）
- 中间人劫持后用私钥B解密得到共享密钥，再用公钥A加密后传给服务器
- 服务器使用私钥A对数据进行节目得到共享密钥
- 这样，双方都拥有来共享密钥

产生中间人攻击的主要原因是因为浏览器无法确认收到的公钥是不是网站自己的，那么是否有一个类似于一个官方机构，给网站颁发一个数字证书呢？（类比于每个人的证明其实就是身份证，是由政府颁发给每个人的）

CA机构就是互联网世界正常运作的前提。网站在使用https前，需要向该机构申领一份数字证书，证书里包含证书持有者信息、公钥信息等。服务器把证书传输给浏览器，浏览器从证书里获取公钥。那么在证书的传输过程中，如何防止被篡改呢？

##### 防止证书被篡改——数字签名
将证书原本的内容生成一份签名，比对证书内容和签名是否一致就能判断是否被篡改。数字签名生成：
- CA机构拥有非对称加密的私钥和公钥
- CA机构对证书明文数据进行hash
- 对hash后的值使用私钥加密，得到数字签名S

浏览器验证过程：
- 拿到证书，得到明文T，签名S
- 用CA机构的公钥对S进行解密（由于是浏览器信任的机构，因此浏览器含有它的公钥），得到S
- 用证书里知名的hash算法对明文T进行hash
- 如果T等于S，则表明证书可信

参考资料：https://zhuanlan.zhihu.com/p/43789231